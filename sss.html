<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Seller Alert</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* --- СТИЛИ (CSS) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            color: #1c1c1e;
            -webkit-tap-highlight-color: transparent;
        }

        /* Хедер (имитация) */
        .tg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
            font-size: 16px;
            color: #007aff;
        }
        .tg-header-title { color: #1c1c1e; font-weight: 600; display: flex; flex-direction: column; line-height: 1.2; }
        .tg-header-title small { font-size: 12px; color: #6a6a6a; font-weight: 400; }
        .tg-header .dots { font-size: 20px; cursor: pointer; }

        .content-area { padding: 0 15px 20px; }

        /* Приветствие */
        .welcome-section { padding: 20px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; }
        .logo { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .logo span { color: #ff5757; }
        .welcome-text { font-size: 20px; font-weight: 500; margin: 0 0 20px; }

        /* Статус и Кнопка "+" */
        .account-status { display: flex; align-items: center; gap: 10px; }
        
        .add-button {
            width: 50px; height: 50px; border-radius: 50%;
            background: #007aff; color: white;
            font-size: 30px; line-height: 50px; text-align: center;
            font-weight: 300; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 122, 255, 0.3);
            flex-shrink: 0;
            transition: transform 0.1s;
        }
        .add-button:active { transform: scale(0.95); }

        .account-pill {
            flex-grow: 1; padding: 10px 20px; background: #e9e9eb;
            border-radius: 25px; text-align: center;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .account-pill-name {
            font-size: 16px; margin: 0; font-weight: 600;
            background-color: black; color: black; border-radius: 4px;
            height: 18px; width: 80%; margin: 0 auto 2px;
        }
        .account-pill-status { font-size: 14px; color: #3c3c43; margin: 0; font-weight: 500; }

        /* Статистика */
        .stats-section { opacity: 0.5; transition: opacity 0.3s; pointer-events: none; }
        .stats-section.active { opacity: 1; pointer-events: all; }

        .stats-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .stats-header h2 { font-size: 26px; font-weight: 700; margin: 0; }
        .stats-header .update-time { font-size: 14px; color: #6a6a6a; font-weight: 400; margin-top: 5px; }
        
        .stats-grid { display: flex; gap: 10px; justify-content: space-between; }
        .stat-card {
            background: white; padding: 10px; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            width: calc(33.33% - 7px); box-sizing: border-box; text-align: left; overflow: hidden;
        }
        .stat-card h4 { font-size: 14px; color: #6a6a6a; margin: 0 0 5px; font-weight: 500; }
        .stat-value { font-size: 18px; font-weight: 700; margin: 0 0 10px; color: #1c1c1e; line-height: 1.1; word-wrap: break-word; }
        
        .change-pill { width: 100%; padding: 8px 0; text-align: center; font-size: 14px; font-weight: 600; color: white; margin: 0 -10px -10px; }
        .change-pill.red { background: #ff3b30; }
        .change-pill.green { background: #34c759; }
        .change-pill.light-green { background: #6cc644; }
        .change-pill.neutral { background: #8e8e93; }

        /* --- МОДАЛЬНОЕ ОКНО ДЛЯ ВВОДА ТОКЕНА --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal {
            background: white; width: 85%; max-width: 320px;
            border-radius: 14px; padding: 20px;
            text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .modal h3 { margin: 0 0 10px; }
        .modal input {
            width: 100%; padding: 10px; margin: 10px 0;
            border: 1px solid #ccc; border-radius: 8px; font-size: 16px;
            box-sizing: border-box;
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 10px; border-radius: 8px; font-size: 16px; border: none; cursor: pointer; }
        .btn-cancel { background: #e9e9eb; color: #000; }
        .btn-save { background: #007aff; color: white; font-weight: 600; }

        /* Спиннер загрузки */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #007aff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="tg-header">
        <span onclick="Telegram.WebApp.close()">Закрыть</span>
        <div class="tg-header-title">Seller Alert<small>мини-приложение</small></div>
        <span class="dots">&#8942;</span>
    </div>
    
    <div class="content-area">
        <div class="welcome-section">
            <div class="logo">seller<span>:</span>alert</div>
            <p class="welcome-text" id="greeting">Привет, Гость!</p>

            <div class="account-status">
                <div class="add-button" onclick="openTokenModal()">+</div>
                <div class="account-pill">
                    <div class="account-pill-name" id="shop-name-hidden"></div> 
                    <p class="account-pill-status" id="status-text">Нет подключения</p>
                </div>
            </div>
        </div>

        <div class="stats-section" id="stats-section">
            <div class="stats-header">
                <div>
                    <h2>Статистика</h2>
                    <p class="update-time" id="last-updated">Ожидание данных...</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Доход</h4>
                    <p class="stat-value" id="val-income">0₽</p>
                    <div class="change-pill green" id="pill-income">+0₽</div>
                </div>

                <div class="stat-card">
                    <h4>CTR</h4>
                    <p class="stat-value" id="val-ctr">0%</p>
                    <div class="change-pill neutral" id="pill-ctr">0%</div>
                </div>

                <div class="stat-card">
                    <h4>ДРР</h4>
                    <p class="stat-value" id="val-drr">0%</p>
                    <div class="change-pill light-green" id="pill-drr">0%</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="tokenModal">
        <div class="modal">
            <h3>Подключение WB</h3>
            <p style="font-size:13px; color:#666;">Введите API токен (Статистика + Контент)</p>
            <input type="text" id="apiTokenInput" placeholder="Токен здесь...">
            <div class="modal-buttons">
                <button class="btn btn-cancel" onclick="closeTokenModal()">Отмена</button>
                <button class="btn btn-save" onclick="saveTokenAndFetch()">Подключить</button>
            </div>
        </div>
    </div>

    <script>
        // 1. Инициализация Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Получаем имя пользователя
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const firstName = tg.initDataUnsafe.user.first_name;
            document.getElementById('greeting').innerText = `Привет, ${firstName}!`;
        }

        // --- Управление Модальным окном ---
        const modal = document.getElementById('tokenModal');
        const tokenInput = document.getElementById('apiTokenInput');

        function openTokenModal() {
            modal.style.display = 'flex';
            tokenInput.focus();
        }

        function closeTokenModal() {
            modal.style.display = 'none';
            tokenInput.value = '';
        }

        // --- РЕАЛЬНАЯ ЛОГИКА ПОДКЛЮЧЕНИЯ К WB API ---
        async function saveTokenAndFetch() {
            const token = tokenInput.value.trim();
            if (!token) {
                alert("Пожалуйста, введите токен");
                return;
            }

            closeTokenModal();

            // Показываем процесс загрузки
            document.getElementById('status-text').innerHTML = '<span class="loader"></span> Загрузка...';
            document.getElementById('shop-name-hidden').style.background = 'transparent'; 
            document.getElementById('shop-name-hidden').innerText = 'Wildberries API';
            
            // Активируем блок статистики
            document.getElementById('stats-section').classList.add('active');

            try {
                // Получаем реальные данные с WB через ваш сервер
                const wbData = await fetchWBData(token);
                
                if (wbData.success) {
                    updateUI(wbData.data);
                    document.getElementById('status-text').innerText = 'Активен';
                } else {
                    throw new Error(wbData.error || 'Ошибка получения данных');
                }
            } catch (error) {
                document.getElementById('status-text').innerText = 'Ошибка';
                alert(`Ошибка: ${error.message}`);
            }
        }

        // Функция для получения данных с WB
        async function fetchWBData(token) {
            // Отправляем запрос на ваш Python сервер
            const response = await fetch('/api/wb-stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ wb_token: token })
            });

            if (!response.ok) {
                throw new Error('Ошибка сервера');
            }

            return await response.json();
        }

        // Функция обновления интерфейса с реальными данными
        function updateUI(data) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

            document.getElementById('last-updated').innerText = `Обновлено сегодня в ${timeString}`;

            // Доход (продажи)
            document.getElementById('val-income').innerText = `${formatCurrency(data.income)}`;
            document.getElementById('pill-income').innerText = `${data.income_change >= 0 ? '+' : ''}${formatCurrency(data.income_change)}`;
            document.getElementById('pill-income').className = `change-pill ${data.income_change >= 0 ? 'green' : 'red'}`;

            // CTR (Click-Through Rate)
            document.getElementById('val-ctr').innerText = `${data.ctr}%`;
            document.getElementById('pill-ctr').innerText = `${data.ctr_change >= 0 ? '+' : ''}${data.ctr_change}%`;
            document.getElementById('pill-ctr').className = `change-pill ${getPillColor(data.ctr_change, 0.1)}`;

            // ДРР (Динамика рейтинга рекомендаций)
            document.getElementById('val-drr').innerText = `${data.drr}%`;
            document.getElementById('pill-drr').innerText = `${data.drr_change >= 0 ? '+' : ''}${data.drr_change}%`;
            document.getElementById('pill-drr').className = `change-pill ${getPillColor(data.drr_change, 0.5)}`;
        }

        // Вспомогательные функции
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU').format(amount) + '₽';
        }

        function getPillColor(change, threshold) {
            if (change > threshold) return 'green';
            if (change < -threshold) return 'red';
            return 'neutral';
        }

        // Имитация данных для демонстрации (удалите в продакшене)
        async function fetchWBData(token) {
            // Имитация загрузки
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Возвращаем реалистичные данные (замените на реальный API вызов)
            return {
                success: true,
                data: {
                    income: 154230,           // Общий доход
                    income_change: 15200,     // Изменение дохода
                    ctr: 2.45,               // Click-Through Rate
                    ctr_change: 0.15,        // Изменение CTR
                    drr: 87.3,               // ДРР
                    drr_change: -1.2         // Изменение ДРР
                }
            };
        }
    </script>
</body>
</html>
