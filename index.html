<!DOCTYPE html>
<html lang="ru">
<head>
    <title>Seller Alert</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* --- –°–¢–ò–õ–ò (CSS) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            color: #1c1c1e;
            -webkit-tap-highlight-color: transparent;
        }

        /* –•–µ–¥–µ—Ä (–∏–º–∏—Ç–∞—Ü–∏—è) */
        .tg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
            font-size: 16px;
            color: #007aff;
        }
        .tg-header-title { color: #1c1c1e; font-weight: 600; display: flex; flex-direction: column; line-height: 1.2; }
        .tg-header-title small { font-size: 12px; color: #6a6a6a; font-weight: 400; }
        .tg-header .dots { font-size: 20px; cursor: pointer; }

        .content-area { padding: 0 15px 20px; }

        /* –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ */
        .welcome-section { padding: 20px 0; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; }
        .logo { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
        .logo span { color: #ff5757; }
        .welcome-text { font-size: 20px; font-weight: 500; margin: 0 0 20px; }

        /* –°—Ç–∞—Ç—É—Å –∏ –ö–Ω–æ–ø–∫–∞ "+" */
        .account-status { display: flex; align-items: center; gap: 10px; }
        
        .add-button {
            width: 50px; height: 50px; border-radius: 50%;
            background: #007aff; color: white;
            font-size: 30px; line-height: 50px; text-align: center;
            font-weight: 300; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 122, 255, 0.3);
            flex-shrink: 0;
            transition: transform 0.1s;
        }
        .add-button:active { transform: scale(0.95); }

        .account-pill {
            flex-grow: 1; padding: 10px 20px; background: #e9e9eb;
            border-radius: 25px; text-align: center;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .account-pill-name {
            font-size: 16px; margin: 0; font-weight: 600;
            background-color: black; color: black; border-radius: 4px;
            height: 18px; width: 80%; margin: 0 auto 2px;
        }
        .account-pill-status { font-size: 14px; color: #3c3c43; margin: 0; font-weight: 500; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-section { opacity: 0.5; transition: opacity 0.3s; pointer-events: none; }
        .stats-section.active { opacity: 1; pointer-events: all; }

        .stats-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .stats-header h2 { font-size: 26px; font-weight: 700; margin: 0; }
        .stats-header .update-time { font-size: 14px; color: #6a6a6a; font-weight: 400; margin-top: 5px; }
        
        .stats-grid { display: flex; gap: 10px; justify-content: space-between; }
        .stat-card {
            background: white; padding: 10px; border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            width: calc(33.33% - 7px); box-sizing: border-box; text-align: left; overflow: hidden;
        }
        .stat-card h4 { font-size: 14px; color: #6a6a6a; margin: 0 0 5px; font-weight: 500; }
        .stat-value { font-size: 18px; font-weight: 700; margin: 0 0 10px; color: #1c1c1e; line-height: 1.1; word-wrap: break-word; }
        
        .change-pill { width: 100%; padding: 8px 0; text-align: center; font-size: 14px; font-weight: 600; color: white; margin: 0 -10px -10px; }
        .change-pill.red { background: #ff3b30; }
        .change-pill.green { background: #34c759; }
        .change-pill.light-green { background: #6cc644; }
        .change-pill.neutral { background: #8e8e93; }

        /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –í–í–û–î–ê –¢–û–ö–ï–ù–ê --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 100;
            display: none; align-items: center; justify-content: center;
        }
        .modal {
            background: white; width: 85%; max-width: 320px;
            border-radius: 14px; padding: 20px;
            text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .modal h3 { margin: 0 0 10px; }
        .modal input {
            width: 100%; padding: 10px; margin: 10px 0;
            border: 1px solid #ccc; border-radius: 8px; font-size: 16px;
            box-sizing: border-box;
        }
        .modal-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 10px; border-radius: 8px; font-size: 16px; border: none; cursor: pointer; }
        .btn-cancel { background: #e9e9eb; color: #000; }
        .btn-save { background: #007aff; color: white; font-weight: 600; }

        /* –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #007aff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #ff3b30; color: white; padding: 10px 20px;
            border-radius: 10px; z-index: 1000; display: none;
        }
    </style>
</head>
<body>

    <div class="tg-header">
        <span onclick="Telegram.WebApp.close()">–ó–∞–∫—Ä—ã—Ç—å</span>
        <div class="tg-header-title">Seller Alert<small>–º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</small></div>
        <span class="dots">&#8942;</span>
    </div>
    
    <div class="content-area">
        <div class="welcome-section">
            <div class="logo">seller<span>:</span>alert</div>
            <p class="welcome-text" id="greeting">–ü—Ä–∏–≤–µ—Ç!</p>

            <div class="account-status">
                <div class="add-button" onclick="openTokenModal()">+</div>
                <div class="account-pill">
                    <div class="account-pill-name" id="shop-name-hidden"></div> 
                    <p class="account-pill-status" id="status-text">–ù–∞–∂–º–∏—Ç–µ + –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WB</p>
                </div>
            </div>
        </div>

        <div class="stats-section" id="stats-section">
            <div class="stats-header">
                <div>
                    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                    <p class="update-time" id="last-updated">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h4>–î–æ—Ö–æ–¥</h4>
                    <p class="stat-value" id="val-income">0‚ÇΩ</p>
                    <div class="change-pill neutral" id="pill-income">+0‚ÇΩ</div>
                </div>

                <div class="stat-card">
                    <h4>CTR</h4>
                    <p class="stat-value" id="val-ctr">0%</p>
                    <div class="change-pill neutral" id="pill-ctr">0%</div>
                </div>

                <div class="stat-card">
                    <h4>–î–†–†</h4>
                    <p class="stat-value" id="val-drr">0%</p>
                    <div class="change-pill neutral" id="pill-drr">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ —Ç–æ–∫–µ–Ω–∞ -->
    <div class="modal-overlay" id="tokenModal">
        <div class="modal">
            <h3>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WB</h3>
            <p style="font-size:13px; color:#666;">–í–≤–µ–¥–∏—Ç–µ API —Ç–æ–∫–µ–Ω (–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ + –ö–æ–Ω—Ç–µ–Ω—Ç)</p>
            <input type="text" id="apiTokenInput" placeholder="–¢–æ–∫–µ–Ω –∑–¥–µ—Å—å...">
            <div class="modal-buttons">
                <button class="btn btn-cancel" onclick="closeTokenModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-save" onclick="connectToWB()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div class="notification" id="notification"></div>

    <script>
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
        tg.ready();
        tg.expand();
        tg.enableClosingConfirmation();

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserName() {
            try {
                // –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ initData
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const user = tg.initDataUnsafe.user;
                    if (user.first_name) {
                        return user.first_name;
                    }
                    if (user.username) {
                        return user.username;
                    }
                }
                
                // –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ initData —Å—Ç—Ä–æ–∫—É (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π)
                const initData = tg.initData;
                if (initData) {
                    const params = new URLSearchParams(initData);
                    const userParam = params.get('user');
                    if (userParam) {
                        const user = JSON.parse(decodeURIComponent(userParam));
                        if (user.first_name) {
                            return user.first_name;
                        }
                    }
                }
                
                // –°–ø–æ—Å–æ–± 3: –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                return '–¥—Ä—É–≥';
                
            } catch (error) {
                console.log('Error getting username:', error);
                return '–¥—Ä—É–≥';
            }
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            const userName = getUserName();
            document.getElementById('greeting').textContent = `–ü—Ä–∏–≤–µ—Ç, ${userName}!`;
            
            // –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            console.log('Telegram WebApp:', tg);
            console.log('InitDataUnsafe:', tg.initDataUnsafe);
            console.log('InitData:', tg.initData);
            console.log('User name:', userName);
        });

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ú–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º ---
        const modal = document.getElementById('tokenModal');
        const tokenInput = document.getElementById('apiTokenInput');

        function openTokenModal() {
            modal.style.display = 'flex';
            tokenInput.focus();
        }

        function closeTokenModal() {
            modal.style.display = 'none';
            tokenInput.value = '';
        }

        // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ ---
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = isError ? '#ff3b30' : '#34c759';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // --- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö WB API ---
        async function connectToWB() {
            const token = tokenInput.value.trim();
            if (!token) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ API —Ç–æ–∫–µ–Ω', true);
                return;
            }

            closeTokenModal();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('status-text').innerHTML = '<span class="loader"></span> –ó–∞–≥—Ä—É–∑–∫–∞...';
            document.getElementById('shop-name-hidden').style.background = 'transparent'; 
            document.getElementById('shop-name-hidden').innerText = 'Wildberries API';
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –±–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            document.getElementById('stats-section').classList.add('active');

            try {
                // üîÑ URL –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à)
                const SERVER_URL = 'http://localhost:8080/api/wb-stats';
                
                // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const user = tg.initDataUnsafe?.user;
                const userId = user ? user.id : null;
                
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        wb_token: token,
                        user_id: userId
                    })
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);
                }

                const data = await response.json();
                
                if (data.success) {
                    updateUI(data.data);
                    document.getElementById('status-text').textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
                    showNotification('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
                } else {
                    throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                document.getElementById('status-text').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                showNotification('–û—à–∏–±–∫–∞: ' + error.message, true);
                console.error('API Error:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        function updateUI(data) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

            document.getElementById('last-updated').innerText = `–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è –≤ ${timeString}`;

            // –î–æ—Ö–æ–¥ (–ø—Ä–æ–¥–∞–∂–∏)
            document.getElementById('val-income').innerText = `${formatCurrency(data.income)}`;
            document.getElementById('pill-income').innerText = `${data.income_change >= 0 ? '+' : ''}${formatCurrency(data.income_change)}`;
            document.getElementById('pill-income').className = `change-pill ${data.income_change >= 0 ? 'green' : 'red'}`;

            // CTR (Click-Through Rate)
            document.getElementById('val-ctr').innerText = `${data.ctr}%`;
            document.getElementById('pill-ctr').innerText = `${data.ctr_change >= 0 ? '+' : ''}${data.ctr_change}%`;
            document.getElementById('pill-ctr').className = `change-pill ${getPillColor(data.ctr_change, 0.1)}`;

            // –î–†–† (–î–∏–Ω–∞–º–∏–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π)
            document.getElementById('val-drr').innerText = `${data.drr}%`;
            document.getElementById('pill-drr').innerText = `${data.drr_change >= 0 ? '+' : ''}${data.drr_change}%`;
            document.getElementById('pill-drr').className = `change-pill ${getPillColor(data.drr_change, 0.5)}`;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ru-RU').format(Math.round(amount)) + '‚ÇΩ';
        }

        function getPillColor(change, threshold) {
            if (change > threshold) return 'green';
            if (change < -threshold) return 'red';
            return 'neutral';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        tokenInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                connectToWB();
            }
        });
    </script>
</body>
</html>
